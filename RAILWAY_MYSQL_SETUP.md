# ğŸ—„ï¸ RAILWAY MYSQL SETUP GUIDE

## ğŸ“‹ RAILWAY MYSQL BIáº¾N MÃ”I TRÆ¯á»œNG

Khi táº¡o MySQL service trÃªn Railway, Railway tá»± Ä‘á»™ng inject cÃ¡c biáº¿n sau:

```env
# Railway MySQL Variables (AUTO-INJECTED)
MYSQLDATABASE=railway
MYSQLHOST=<railway-private-domain>      # DÃ¹ng cÃ¡i nÃ y (miá»…n phÃ­)
MYSQLPASSWORD=<auto-generated>
MYSQLPORT=3306
MYSQLUSER=root

# Connection URLs
MYSQL_URL=mysql://root:password@<private-domain>:3306/railway
MYSQL_PUBLIC_URL=mysql://root:password@<public-domain>:port/railway  # âš ï¸ Tá»N TIá»€N!

# Railway Network
RAILWAY_PRIVATE_DOMAIN=<service>.railway.internal  # âœ… DÃ™NG CÃI NÃ€Y
RAILWAY_TCP_PROXY_DOMAIN=<public>.proxy.rlwy.net   # âŒ Äá»ªNG DÃ™NG (tá»‘n egress)
```

---

## âš ï¸ QUAN TRá»ŒNG: TRÃNH EGRESS FEES

### âŒ Äá»ªNG DÃ™NG:
- `MYSQL_PUBLIC_URL`
- `RAILWAY_TCP_PROXY_DOMAIN`
- `RAILWAY_TCP_PROXY_PORT`

**Táº¡i sao?**
- Äi qua public internet â†’ Railway tÃ­nh phÃ­ egress
- Cháº­m hÆ¡n
- KhÃ´ng cáº§n thiáº¿t (services trong cÃ¹ng project)

### âœ… DÃ™NG:
- `MYSQLHOST` (tá»± Ä‘á»™ng dÃ¹ng RAILWAY_PRIVATE_DOMAIN)
- `MYSQL_URL` (internal connection)

**Lá»£i Ã­ch:**
- âœ… Miá»…n phÃ­ (private network)
- âœ… Nhanh hÆ¡n
- âœ… An toÃ n hÆ¡n

---

## ğŸ”§ LARAVEL CONFIGURATION

### Backend (.env.example Ä‘Ã£ config sáºµn)

```env
# Railway MySQL Configuration
DB_CONNECTION=mysql
DB_HOST=${MYSQLHOST}              # Railway injects nÃ y
DB_PORT=${MYSQLPORT}              # Railway injects nÃ y
DB_DATABASE=${MYSQLDATABASE}      # Railway injects nÃ y
DB_USERNAME=${MYSQLUSER}          # Railway injects nÃ y
DB_PASSWORD=${MYSQLPASSWORD}      # Railway injects nÃ y
```

### Frontend (.env.example Ä‘Ã£ config sáºµn)

Giá»‘ng Backend, cÃ¹ng dÃ¹ng chung MySQL database.

---

## ğŸš€ BÆ¯á»šC SETUP TRÃŠN RAILWAY

### 1ï¸âƒ£ Táº¡o MySQL Service

1. VÃ o Railway project
2. Click **"+ New"**
3. Chá»n **"Database"** â†’ **"Add MySQL"**
4. Railway tá»± Ä‘á»™ng:
   - Táº¡o database `railway`
   - Generate password
   - Setup private network
   - Inject biáº¿n vÃ o táº¥t cáº£ services

### 2ï¸âƒ£ Connect Backend Service vá»›i MySQL

**QUAN TRá»ŒNG:** Railway Tá»° Äá»˜NG inject variables, **KHÃ”NG Cáº¦N** thÃªm thá»§ cÃ´ng!

NhÆ°ng Ä‘á»ƒ cháº¯c cháº¯n:

1. VÃ o **Backend service** â†’ tab **"Variables"**
2. Kiá»ƒm tra cÃ³ cÃ¡c biáº¿n sau (Railway tá»± add):
   ```
   MYSQLDATABASE
   MYSQLHOST
   MYSQLPASSWORD
   MYSQLPORT
   MYSQLUSER
   ```

3. Náº¿u khÃ´ng tháº¥y, click **"+ New Variable"** â†’ **"Add Reference"**:
   - Chá»n MySQL service
   - Railway sáº½ tá»± Ä‘á»™ng link

### 3ï¸âƒ£ Connect Frontend Service vá»›i MySQL

LÃ m tÆ°Æ¡ng tá»± Backend:

1. VÃ o **Frontend service** â†’ tab **"Variables"**
2. Verify MySQL variables Ä‘Æ°á»£c inject
3. Náº¿u chÆ°a cÃ³, add reference tá»›i MySQL service

---

## ğŸ” VERIFY CONNECTION

### Trong Railway Logs:

Khi container start, báº¡n sáº½ tháº¥y:

```bash
â³ Waiting for database connection...
   Host: mysql.railway.internal
   Port: 3306
   Database: railway
âœ… Database is ready!
ğŸ“¦ Running migrations...
```

### Náº¿u tháº¥y lá»—i:

```bash
Database is not ready yet, waiting 2 seconds...
Database is not ready yet, waiting 2 seconds...
```

**NguyÃªn nhÃ¢n:**
- MySQL service chÆ°a start xong
- Biáº¿n mÃ´i trÆ°á»ng chÆ°a Ä‘Æ°á»£c inject
- Network issue

**Fix:**
1. Verify MySQL service Ä‘ang cháº¡y (green checkmark)
2. Verify "Add Reference" Ä‘Ã£ lÃ m Ä‘Ãºng
3. Redeploy Backend/Frontend service

---

## ğŸ“Š DATABASE STRUCTURE

### Option 1: Shared Database (KHUYÃŠN DÃ™NG cho nhá»/medium apps)

```
MySQL Service (railway)
â”œâ”€â”€ Backend tables
â”‚   â”œâ”€â”€ users
â”‚   â”œâ”€â”€ employees
â”‚   â”œâ”€â”€ departments
â”‚   â””â”€â”€ ...
â”‚
â””â”€â”€ Frontend tables
    â”œâ”€â”€ sessions
    â””â”€â”€ cache
```

**Æ¯u Ä‘iá»ƒm:**
- ÄÆ¡n giáº£n
- 1 database service = ráº» hÆ¡n
- Dá»… backup

**NhÆ°á»£c Ä‘iá»ƒm:**
- KhÃ´ng tÃ¡ch biá»‡t data
- CÃ³ thá»ƒ conflict table names

---

### Option 2: Separate Databases (cho large apps)

**Táº¡o 2 MySQL services:**

```
MySQL Backend (hr_backend)
â”œâ”€â”€ users
â”œâ”€â”€ employees
â””â”€â”€ ...

MySQL Frontend (hr_frontend)
â”œâ”€â”€ sessions
â””â”€â”€ cache
```

**Setup:**
1. Táº¡o 2 MySQL services riÃªng
2. Backend connect tá»›i MySQL Backend
3. Frontend connect tá»›i MySQL Frontend

**Æ¯u Ä‘iá»ƒm:**
- TÃ¡ch biá»‡t hoÃ n toÃ n
- Scale Ä‘á»™c láº­p

**NhÆ°á»£c Ä‘iá»ƒm:**
- Tá»‘n chi phÃ­ hÆ¡n (2 databases)
- Phá»©c táº¡p hÆ¡n

---

## ğŸ’¡ KHUYáº¾N NGHá»Š

### Cho dá»± Ã¡n cá»§a báº¡n (HR Management):

**DÃ™NG SHARED DATABASE** (Option 1)

**LÃ½ do:**
- Backend vÃ  Frontend Ä‘á»u Laravel â†’ Dá»… manage
- KhÃ´ng conflict (Backend cÃ³ prefix `employees`, Frontend cÃ³ `sessions`)
- Tiáº¿t kiá»‡m chi phÃ­
- Dá»… migration data giá»¯a BE/FE

**Setup:**
```
Railway Project
â”œâ”€â”€ MySQL (shared)           # 1 database cho cáº£ 2
â”œâ”€â”€ Backend â†’ connect MySQL
â””â”€â”€ Frontend â†’ connect MySQL
```

---

## ğŸ”’ SECURITY

### Railway Private Network

- Táº¥t cáº£ services trong cÃ¹ng project dÃ¹ng private network
- MySQL **KHÃ”NG** expose ra public internet
- Chá»‰ services trong project má»›i access Ä‘Æ°á»£c

### Connection String

```bash
# Internal (private network) - âœ… DÃ™NG
mysql://root:password@mysql.railway.internal:3306/railway

# External (public) - âŒ Äá»ªNG DÃ™NG
mysql://root:password@abc.proxy.rlwy.net:12345/railway
```

---

## ğŸ§ª TESTING CONNECTION

### Test tá»« Backend/Frontend Container

Railway CLI:
```bash
# Link to service
railway link

# Get shell access
railway shell

# Test MySQL connection
php artisan db:monitor

# Or direct MySQL
mysql -h $MYSQLHOST -u $MYSQLUSER -p$MYSQLPASSWORD $MYSQLDATABASE
```

### Test Migration

```bash
# SSH vÃ o container
railway shell

# Check migrations status
php artisan migrate:status

# Run fresh migrations (âš ï¸ XÃ“A DATA!)
php artisan migrate:fresh --seed
```

---

## ğŸ“ˆ MONITORING

### Railway Dashboard

1. Click vÃ o MySQL service
2. Tab **"Metrics"**:
   - CPU usage
   - Memory usage
   - Connections
   - Query performance

3. Tab **"Data"** (náº¿u cÃ³ plugin):
   - Browse tables
   - Run queries
   - Export data

---

## ğŸ’¾ BACKUP

### Option 1: Railway Snapshot (Recommended)

1. MySQL service â†’ **"Settings"**
2. **"Backup"** section
3. Enable automatic backups
4. Schedule: Daily/Weekly

### Option 2: Manual mysqldump

```bash
# Get MySQL credentials tá»« Railway
railway variables

# Dump database
mysqldump -h <MYSQLHOST> -u <MYSQLUSER> -p<MYSQLPASSWORD> <MYSQLDATABASE> > backup.sql

# Restore
mysql -h <MYSQLHOST> -u <MYSQLUSER> -p<MYSQLPASSWORD> <MYSQLDATABASE> < backup.sql
```

---

## ğŸš¨ TROUBLESHOOTING

### Lá»—i: "SQLSTATE[HY000] [2002] Connection refused"

**NguyÃªn nhÃ¢n:** MySQL service chÆ°a start hoáº·c biáº¿n env chÆ°a inject

**Fix:**
1. Check MySQL service Ä‘ang cháº¡y
2. Verify variables trong Backend/Frontend service
3. Add Reference náº¿u chÆ°a cÃ³

---

### Lá»—i: "SQLSTATE[42000]: Access denied"

**NguyÃªn nhÃ¢n:** Sai password hoáº·c username

**Fix:**
1. Verify `MYSQLUSER` vÃ  `MYSQLPASSWORD`
2. KhÃ´ng hardcode password, dÃ¹ng Railway variables
3. Redeploy Ä‘á»ƒ load variables má»›i

---

### Lá»—i: "Database 'railway' doesn't exist"

**NguyÃªn nhÃ¢n:** Database máº·c Ä‘á»‹nh bá»‹ xÃ³a

**Fix:**
```bash
# SSH vÃ o MySQL service hoáº·c dÃ¹ng Railway CLI
railway run mysql -u root -p

# Táº¡o láº¡i database
CREATE DATABASE railway;
```

---

### Lá»—i: Migration stuck / timeout

**NguyÃªn nhÃ¢n:** Database chÆ°a ready hoáº·c migration quÃ¡ lá»›n

**Fix:**
- Script Ä‘Ã£ cÃ³ retry logic (wait 2s)
- Náº¿u váº«n fail, check MySQL service logs
- Increase healthcheck timeout trong railway.toml

---

## âœ… CHECKLIST

Setup MySQL trÃªn Railway:

- [ ] MySQL service Ä‘Ã£ táº¡o
- [ ] Backend service cÃ³ MySQL variables
- [ ] Frontend service cÃ³ MySQL variables
- [ ] DÃ¹ng PRIVATE domain (khÃ´ng pháº£i PUBLIC)
- [ ] .env.example Ä‘Ã£ map Ä‘Ãºng variables
- [ ] docker-entrypoint.sh cÃ³ database wait
- [ ] Test migration thÃ nh cÃ´ng
- [ ] Backup Ä‘Æ°á»£c enable (optional)

---

## ğŸ¯ TÃ“M Táº®T

### Biáº¿n Railway â†’ Biáº¿n Laravel

```
Railway          â†’ Laravel
---------------------------------
MYSQLHOST        â†’ DB_HOST
MYSQLPORT        â†’ DB_PORT
MYSQLDATABASE    â†’ DB_DATABASE
MYSQLUSER        â†’ DB_USERNAME
MYSQLPASSWORD    â†’ DB_PASSWORD
```

### CÃ¡ch hoáº¡t Ä‘á»™ng

1. Railway táº¡o MySQL service
2. Railway tá»± inject MYSQL* variables vÃ o services
3. Laravel Ä‘á»c variables tá»« .env
4. docker-entrypoint.sh wait cho MySQL ready
5. Migration cháº¡y tá»± Ä‘á»™ng khi container start
6. âœ… App káº¿t ná»‘i thÃ nh cÃ´ng!

---

**Ready to deploy! ğŸš€**

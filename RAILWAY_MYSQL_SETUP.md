# 🗄️ RAILWAY MYSQL SETUP GUIDE

## 📋 RAILWAY MYSQL BIẾN MÔI TRƯỜNG

Khi tạo MySQL service trên Railway, Railway tự động inject các biến sau:

```env
# Railway MySQL Variables (AUTO-INJECTED)
MYSQLDATABASE=railway
MYSQLHOST=<railway-private-domain>      # Dùng cái này (miễn phí)
MYSQLPASSWORD=<auto-generated>
MYSQLPORT=3306
MYSQLUSER=root

# Connection URLs
MYSQL_URL=mysql://root:password@<private-domain>:3306/railway
MYSQL_PUBLIC_URL=mysql://root:password@<public-domain>:port/railway  # ⚠️ TỐN TIỀN!

# Railway Network
RAILWAY_PRIVATE_DOMAIN=<service>.railway.internal  # ✅ DÙNG CÁI NÀY
RAILWAY_TCP_PROXY_DOMAIN=<public>.proxy.rlwy.net   # ❌ ĐỪNG DÙNG (tốn egress)
```

---

## ⚠️ QUAN TRỌNG: TRÁNH EGRESS FEES

### ❌ ĐỪNG DÙNG:
- `MYSQL_PUBLIC_URL`
- `RAILWAY_TCP_PROXY_DOMAIN`
- `RAILWAY_TCP_PROXY_PORT`

**Tại sao?**
- Đi qua public internet → Railway tính phí egress
- Chậm hơn
- Không cần thiết (services trong cùng project)

### ✅ DÙNG:
- `MYSQLHOST` (tự động dùng RAILWAY_PRIVATE_DOMAIN)
- `MYSQL_URL` (internal connection)

**Lợi ích:**
- ✅ Miễn phí (private network)
- ✅ Nhanh hơn
- ✅ An toàn hơn

---

## 🔧 LARAVEL CONFIGURATION

### Backend (.env.example đã config sẵn)

```env
# Railway MySQL Configuration
DB_CONNECTION=mysql
DB_HOST=${MYSQLHOST}              # Railway injects này
DB_PORT=${MYSQLPORT}              # Railway injects này
DB_DATABASE=${MYSQLDATABASE}      # Railway injects này
DB_USERNAME=${MYSQLUSER}          # Railway injects này
DB_PASSWORD=${MYSQLPASSWORD}      # Railway injects này
```

### Frontend (.env.example đã config sẵn)

Giống Backend, cùng dùng chung MySQL database.

---

## 🚀 BƯỚC SETUP TRÊN RAILWAY

### 1️⃣ Tạo MySQL Service

1. Vào Railway project
2. Click **"+ New"**
3. Chọn **"Database"** → **"Add MySQL"**
4. Railway tự động:
   - Tạo database `railway`
   - Generate password
   - Setup private network
   - Inject biến vào tất cả services

### 2️⃣ Connect Backend Service với MySQL

**QUAN TRỌNG:** Railway TỰ ĐỘNG inject variables, **KHÔNG CẦN** thêm thủ công!

Nhưng để chắc chắn:

1. Vào **Backend service** → tab **"Variables"**
2. Kiểm tra có các biến sau (Railway tự add):
   ```
   MYSQLDATABASE
   MYSQLHOST
   MYSQLPASSWORD
   MYSQLPORT
   MYSQLUSER
   ```

3. Nếu không thấy, click **"+ New Variable"** → **"Add Reference"**:
   - Chọn MySQL service
   - Railway sẽ tự động link

### 3️⃣ Connect Frontend Service với MySQL

Làm tương tự Backend:

1. Vào **Frontend service** → tab **"Variables"**
2. Verify MySQL variables được inject
3. Nếu chưa có, add reference tới MySQL service

---

## 🔍 VERIFY CONNECTION

### Trong Railway Logs:

Khi container start, bạn sẽ thấy:

```bash
⏳ Waiting for database connection...
   Host: mysql.railway.internal
   Port: 3306
   Database: railway
✅ Database is ready!
📦 Running migrations...
```

### Nếu thấy lỗi:

```bash
Database is not ready yet, waiting 2 seconds...
Database is not ready yet, waiting 2 seconds...
```

**Nguyên nhân:**
- MySQL service chưa start xong
- Biến môi trường chưa được inject
- Network issue

**Fix:**
1. Verify MySQL service đang chạy (green checkmark)
2. Verify "Add Reference" đã làm đúng
3. Redeploy Backend/Frontend service

---

## 📊 DATABASE STRUCTURE

### Option 1: Shared Database (KHUYÊN DÙNG cho nhỏ/medium apps)

```
MySQL Service (railway)
├── Backend tables
│   ├── users
│   ├── employees
│   ├── departments
│   └── ...
│
└── Frontend tables
    ├── sessions
    └── cache
```

**Ưu điểm:**
- Đơn giản
- 1 database service = rẻ hơn
- Dễ backup

**Nhược điểm:**
- Không tách biệt data
- Có thể conflict table names

---

### Option 2: Separate Databases (cho large apps)

**Tạo 2 MySQL services:**

```
MySQL Backend (hr_backend)
├── users
├── employees
└── ...

MySQL Frontend (hr_frontend)
├── sessions
└── cache
```

**Setup:**
1. Tạo 2 MySQL services riêng
2. Backend connect tới MySQL Backend
3. Frontend connect tới MySQL Frontend

**Ưu điểm:**
- Tách biệt hoàn toàn
- Scale độc lập

**Nhược điểm:**
- Tốn chi phí hơn (2 databases)
- Phức tạp hơn

---

## 💡 KHUYẾN NGHỊ

### Cho dự án của bạn (HR Management):

**DÙNG SHARED DATABASE** (Option 1)

**Lý do:**
- Backend và Frontend đều Laravel → Dễ manage
- Không conflict (Backend có prefix `employees`, Frontend có `sessions`)
- Tiết kiệm chi phí
- Dễ migration data giữa BE/FE

**Setup:**
```
Railway Project
├── MySQL (shared)           # 1 database cho cả 2
├── Backend → connect MySQL
└── Frontend → connect MySQL
```

---

## 🔒 SECURITY

### Railway Private Network

- Tất cả services trong cùng project dùng private network
- MySQL **KHÔNG** expose ra public internet
- Chỉ services trong project mới access được

### Connection String

```bash
# Internal (private network) - ✅ DÙNG
mysql://root:password@mysql.railway.internal:3306/railway

# External (public) - ❌ ĐỪNG DÙNG
mysql://root:password@abc.proxy.rlwy.net:12345/railway
```

---

## 🧪 TESTING CONNECTION

### Test từ Backend/Frontend Container

Railway CLI:
```bash
# Link to service
railway link

# Get shell access
railway shell

# Test MySQL connection
php artisan db:monitor

# Or direct MySQL
mysql -h $MYSQLHOST -u $MYSQLUSER -p$MYSQLPASSWORD $MYSQLDATABASE
```

### Test Migration

```bash
# SSH vào container
railway shell

# Check migrations status
php artisan migrate:status

# Run fresh migrations (⚠️ XÓA DATA!)
php artisan migrate:fresh --seed
```

---

## 📈 MONITORING

### Railway Dashboard

1. Click vào MySQL service
2. Tab **"Metrics"**:
   - CPU usage
   - Memory usage
   - Connections
   - Query performance

3. Tab **"Data"** (nếu có plugin):
   - Browse tables
   - Run queries
   - Export data

---

## 💾 BACKUP

### Option 1: Railway Snapshot (Recommended)

1. MySQL service → **"Settings"**
2. **"Backup"** section
3. Enable automatic backups
4. Schedule: Daily/Weekly

### Option 2: Manual mysqldump

```bash
# Get MySQL credentials từ Railway
railway variables

# Dump database
mysqldump -h <MYSQLHOST> -u <MYSQLUSER> -p<MYSQLPASSWORD> <MYSQLDATABASE> > backup.sql

# Restore
mysql -h <MYSQLHOST> -u <MYSQLUSER> -p<MYSQLPASSWORD> <MYSQLDATABASE> < backup.sql
```

---

## 🚨 TROUBLESHOOTING

### Lỗi: "SQLSTATE[HY000] [2002] Connection refused"

**Nguyên nhân:** MySQL service chưa start hoặc biến env chưa inject

**Fix:**
1. Check MySQL service đang chạy
2. Verify variables trong Backend/Frontend service
3. Add Reference nếu chưa có

---

### Lỗi: "SQLSTATE[42000]: Access denied"

**Nguyên nhân:** Sai password hoặc username

**Fix:**
1. Verify `MYSQLUSER` và `MYSQLPASSWORD`
2. Không hardcode password, dùng Railway variables
3. Redeploy để load variables mới

---

### Lỗi: "Database 'railway' doesn't exist"

**Nguyên nhân:** Database mặc định bị xóa

**Fix:**
```bash
# SSH vào MySQL service hoặc dùng Railway CLI
railway run mysql -u root -p

# Tạo lại database
CREATE DATABASE railway;
```

---

### Lỗi: Migration stuck / timeout

**Nguyên nhân:** Database chưa ready hoặc migration quá lớn

**Fix:**
- Script đã có retry logic (wait 2s)
- Nếu vẫn fail, check MySQL service logs
- Increase healthcheck timeout trong railway.toml

---

## ✅ CHECKLIST

Setup MySQL trên Railway:

- [ ] MySQL service đã tạo
- [ ] Backend service có MySQL variables
- [ ] Frontend service có MySQL variables
- [ ] Dùng PRIVATE domain (không phải PUBLIC)
- [ ] .env.example đã map đúng variables
- [ ] docker-entrypoint.sh có database wait
- [ ] Test migration thành công
- [ ] Backup được enable (optional)

---

## 🎯 TÓM TẮT

### Biến Railway → Biến Laravel

```
Railway          → Laravel
---------------------------------
MYSQLHOST        → DB_HOST
MYSQLPORT        → DB_PORT
MYSQLDATABASE    → DB_DATABASE
MYSQLUSER        → DB_USERNAME
MYSQLPASSWORD    → DB_PASSWORD
```

### Cách hoạt động

1. Railway tạo MySQL service
2. Railway tự inject MYSQL* variables vào services
3. Laravel đọc variables từ .env
4. docker-entrypoint.sh wait cho MySQL ready
5. Migration chạy tự động khi container start
6. ✅ App kết nối thành công!

---

**Ready to deploy! 🚀**
